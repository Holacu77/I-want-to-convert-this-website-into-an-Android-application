<?php
require 'csrf.php'; 
require 'auth.php';
require 'access_control.php';
$pageTitle = "عرض وتصدير النتائج التفصيلية";
require 'config.php';
include 'header.php';

// 1. استعلام الملخص العام لجميع المرشحين
$globalQuery = "
  SELECT c.candidate_name, SUM(v.vote_count) AS total_votes
    FROM votes v
      JOIN candidates c ON v.candidate_id = c.id
        GROUP BY c.id
          ORDER BY total_votes DESC
          ";
          $stmt = $pdo->query($globalQuery);
          $globalResults = $stmt->fetchAll(PDO::FETCH_ASSOC);

          // 2. استعلام بيانات المراكز وجمع التفاصيل
          // (أ) إجمالي الأصوات بكل مركز
          $centerTotalsQuery = "
            SELECT ct.id AS center_id, ct.center_name, SUM(v.vote_count) AS center_total
              FROM votes v
                JOIN centers ct ON v.center_id = ct.id
                  GROUP BY ct.id
                    ORDER BY center_total DESC
                    ";
                    $stmt = $pdo->query($centerTotalsQuery);
                    $centerTotals = $stmt->fetchAll(PDO::FETCH_ASSOC);

                    // بناء هيكل البيانات
                    $centersData = [];
                    foreach ($centerTotals as $row) {
                        $centersData[$row['center_id']] = [
                                'center_name'  => $row['center_name'],
                                        'center_total' => $row['center_total'],
                                                'candidates'   => [],
                                                        'stations'     => []
                                                            ];
                                                            }

                                                            // (ب) تجميع أصوات المرشحين داخل كل مركز
                                                            $centerCandidateQuery = "
                                                              SELECT ct.id AS center_id, c.candidate_name, SUM(v.vote_count) AS candidate_votes
                                                                FROM votes v
                                                                  JOIN centers ct ON v.center_id = ct.id
                                                                    JOIN candidates c ON v.candidate_id = c.id
                                                                      GROUP BY ct.id, c.id
                                                                        ORDER BY candidate_votes DESC
                                                                        ";
                                                                        $stmt = $pdo->query($centerCandidateQuery);
                                                                        foreach ($stmt->fetchAll(PDO::FETCH_ASSOC) as $row) {
                                                                            $centersData[$row['center_id']]['candidates'][] = [
                                                                                    'candidate_name' => $row['candidate_name'],
                                                                                            'candidate_votes'=> $row['candidate_votes']
                                                                                                ];
                                                                                                }

                                                                                                // (ج) تجميع المحطات وإجمالي الأصوات داخل كل مركز
                                                                                                $stationTotalsQuery = "
                                                                                                  SELECT ct.id AS center_id, s.id AS station_id, s.station_number, SUM(v.vote_count) AS station_total
                                                                                                    FROM votes v
                                                                                                      JOIN centers ct ON v.center_id = ct.id
                                                                                                        JOIN stations s ON v.station_id = s.id
                                                                                                          GROUP BY ct.id, s.id
                                                                                                            ORDER BY s.station_number
                                                                                                            ";
                                                                                                            $stmt = $pdo->query($stationTotalsQuery);
                                                                                                            foreach ($stmt->fetchAll(PDO::FETCH_ASSOC) as $row) {
                                                                                                                $centersData[$row['center_id']]['stations'][$row['station_id']] = [
                                                                                                                        'station_number' => $row['station_number'],
                                                                                                                                'station_total'  => $row['station_total'],
                                                                                                                                        'candidates'     => []
                                                                                                                                            ];
                                                                                                                                            }

                                                                                                                                            // (د) تجميع أصوات المرشحين داخل كل محطة
                                                                                                                                            $stationCandidateQuery = "
                                                                                                                                              SELECT s.id AS station_id, c.candidate_name, SUM(v.vote_count) AS candidate_votes
                                                                                                                                                FROM votes v
                                                                                                                                                  JOIN stations s ON v.station_id = s.id
                                                                                                                                                    JOIN candidates c ON v.candidate_id = c.id
                                                                                                                                                      GROUP BY s.id, c.id
                                                                                                                                                        ORDER BY s.station_number, candidate_votes DESC
                                                                                                                                                        ";
                                                                                                                                                        $stmt = $pdo->query($stationCandidateQuery);
                                                                                                                                                        foreach ($stmt->fetchAll(PDO::FETCH_ASSOC) as $row) {
                                                                                                                                                            foreach ($centersData as &$center) {
                                                                                                                                                                    if (isset($center['stations'][$row['station_id']])) {
                                                                                                                                                                                $center['stations'][$row['station_id']]['candidates'][] = [
                                                                                                                                                                                                'candidate_name' => $row['candidate_name'],
                                                                                                                                                                                                                'candidate_votes'=> $row['candidate_votes']
                                                                                                                                                                                                                            ];
                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                        unset($center);
                                                                                                                                                                                                                                        ?>

                                                                                                                                                                                                                                        <div class="container my-4">
                                                                                                                                                                                                                                          <h2 class="text-center mb-4">عرض النتائج التفصيلية</h2>

                                                                                                                                                                                                                                            <div class="text-center mb-4">
                                                                                                                                                                                                                                                <button onclick="exportToPDF()" class="btn btn-danger">تصدير PDF</button>
                                                                                                                                                                                                                                                    <button onclick="exportToExcel()" class="btn btn-success">تصدير Excel</button>
                                                                                                                                                                                                                                                      </div>

                                                                                                                                                                                                                                                        <div id="export-area">
                                                                                                                                                                                                                                                            <div class="card mb-4 shadow-sm">
                                                                                                                                                                                                                                                                  <div class="card-header bg-info text-white">
                                                                                                                                                                                                                                                                          <h4 class="mb-0">الملخص العام للمرشحين</h4>
                                                                                                                                                                                                                                                                                </div>
                                                                                                                                                                                                                                                                                      <div class="card-body">
                                                                                                                                                                                                                                                                                              <table class="table table-bordered table-hover">
                                                                                                                                                                                                                                                                                                        <thead class="table-secondary">
                                                                                                                                                                                                                                                                                                                    <tr><th>اسم المرشح</th><th>إجمالي الأصوات</th></tr>
                                                                                                                                                                                                                                                                                                                              </thead>
                                                                                                                                                                                                                                                                                                                                        <tbody>
                                                                                                                                                                                                                                                                                                                                                    <?php if (!empty($globalResults)): ?>
                                                                                                                                                                                                                                                                                                                                                                  <?php foreach ($globalResults as $row): ?>
                                                                                                                                                                                                                                                                                                                                                                                  <tr>
                                                                                                                                                                                                                                                                                                                                                                                                    <td><?= htmlspecialchars($row['candidate_name']) ?></td>
                                                                                                                                                                                                                                                                                                                                                                                                                      <td><?= htmlspecialchars($row['total_votes']) ?></td>
                                                                                                                                                                                                                                                                                                                                                                                                                                      </tr>
                                                                                                                                                                                                                                                                                                                                                                                                                                                    <?php endforeach; ?>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                <?php else: ?>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <tr><td colspan="2" class="text-center">لا توجد بيانات.</td></tr>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <?php endif; ?>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      </tbody>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              </table>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </div>

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <div id="centersContainer">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  <?php if (!empty($centersData)): ?>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          <?php foreach ($centersData as $center): ?>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <div class="card mb-4 shadow-sm">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <div class="card-header bg-primary text-white d-flex justify-content-between">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              <span><?= htmlspecialchars($center['center_name']) ?></span>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <small>إجمالي الأصوات: <?= htmlspecialchars($center['center_total']) ?></small>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <div class="card-body">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  <h5>أصوات المرشحين بالمركز</h5>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <div class="table-responsive">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <table class="table table-bordered">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  <thead class="table-light"><tr><th>المرشح</th><th>الأصوات</th></tr></thead>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <tbody>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <?php foreach ($center['candidates'] as $cand): ?>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              <tr><td><?= htmlspecialchars($cand['candidate_name']) ?></td><td><?= htmlspecialchars($cand['candidate_votes']) ?></td></tr>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  <?php endforeach; ?>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </tbody>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </table>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  </div>

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <h5 class="mt-3">أصوات المرشحين بالمحطات</h5>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              <?php foreach ($center['stations'] as $station): ?>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              <h6>محطة <?= htmlspecialchars($station['station_number']) ?> - إجمالي: <?= htmlspecialchars($station['station_total']) ?></h6>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              <div class="table-responsive mb-2">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <table class="table table-sm table-bordered">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <thead class="table-light"><tr><th>المرشح</th><th>الأصوات</th></tr></thead>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <tbody>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              <?php foreach ($station['candidates'] as $sc): ?>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      <tr><td><?= htmlspecialchars($sc['candidate_name']) ?></td><td><?= htmlspecialchars($sc['candidate_votes']) ?></td></tr>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <?php endforeach; ?>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </tbody>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  </table>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <?php endforeach; ?>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              <?php endforeach; ?>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <?php else: ?>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <p class="text-center">لا توجد بيانات للعرض.</p>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  <?php endif; ?>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </div>

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <?php include 'pdf.php'; ?>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <?php include 'excel.php'; ?>

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <?php include 'footer.php'; ?>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        