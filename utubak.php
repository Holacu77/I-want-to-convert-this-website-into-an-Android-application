<?php

require 'csrf.php';
/**
 * utubak.php
  * Automatic backup and Dropbox upload triggered every 15 minutes,
   * with automatic refresh of the Dropbox access token using a refresh token.
    */

    // Enable error reporting for debugging (remove in production)
    ini_set('display_errors', 1);
    error_reporting(E_ALL);

    // Load config and backup functions
    require __DIR__ . '/config.php';
    require __DIR__ . '/backup_functions.php';

    // ===== Configure Dropox credentials below =====
    define('DROPBOX_APP_KEY',      'cpe6s1we01ikuy4');
    define('DROPBOX_APP_SECRET',   'cwwgvzworsbz17a');
    define('DROPBOX_REFRESH_TOKEN','rSSDkpFajXIAAAAAAAAAAR_lEL0SNyhiIWo9-VHcTCklrEvlHbT-naCKnYzb40pE');

    // File to cache Dropbox access token
    $tokenFile = __DIR__ . '/bk/.dropbox_token.json';

    /**
     * Get a valid Dropbox access token, refreshing if needed
      */
      function getDropboxAccessToken() {
          global $tokenFile;
              // Load existing token data
                  if (file_exists($tokenFile)) {
                          $data = json_decode(file_get_contents($tokenFile), true);
                                  if (!empty($data['access_token']) && time() < ($data['obtained_at'] + $data['expires_in'] - 60)) {
                                              return $data['access_token'];
                                                      }
                                                          }
                                                              // Refresh token request
                                                                  $ch = curl_init('https://api.dropbox.com/oauth2/token');
                                                                      curl_setopt_array($ch, [
                                                                              CURLOPT_POST           => true,
                                                                                      CURLOPT_RETURNTRANSFER => true,
                                                                                              CURLOPT_HTTPHEADER     => ['Content-Type: application/x-www-form-urlencoded'],
                                                                                                      CURLOPT_POSTFIELDS     => http_build_query([
                                                                                                                  'grant_type'    => 'refresh_token',
                                                                                                                              'refresh_token' => DROPBOX_REFRESH_TOKEN,
                                                                                                                                          'client_id'     => DROPBOX_APP_KEY,
                                                                                                                                                      'client_secret' => DROPBOX_APP_SECRET,
                                                                                                                                                              ]),
                                                                                                                                                                  ]);
                                                                                                                                                                      $res  = curl_exec($ch);
                                                                                                                                                                          $code = curl_getinfo($ch, CURLINFO_HTTP_CODE);
                                                                                                                                                                              curl_close($ch);

                                                                                                                                                                                  if ($code === 200) {
                                                                                                                                                                                          $new = json_decode($res, true);
                                                                                                                                                                                                  $new['obtained_at'] = time();
                                                                                                                                                                                                          file_put_contents($tokenFile, json_encode($new));
                                                                                                                                                                                                                  return $new['access_token'];
                                                                                                                                                                                                                      }
                                                                                                                                                                                                                          error_log("Dropbox token refresh failed ($code): $res");
                                                                                                                                                                                                                              return null;
                                                                                                                                                                                                                              }

                                                                                                                                                                                                                              // Backup control paths
                                                                                                                                                                                                                              $bkDir    = __DIR__ . '/bk';
                                                                                                                                                                                                                              $flagFile = "$bkDir/auto_backup_enabled.txt";
                                                                                                                                                                                                                              $timeFile = "$bkDir/last_autobackup_time.txt";

                                                                                                                                                                                                                              // If auto-backup enabled, and 15 minutes passed, run backup
                                                                                                                                                                                                                              if (file_exists($flagFile) && trim(file_get_contents($flagFile)) === '1') {
                                                                                                                                                                                                                                  $now  = time();
                                                                                                                                                                                                                                      $last = file_exists($timeFile) ? (int)file_get_contents($timeFile) : 0;

                                                                                                                                                                                                                                          if ($now - $last >= 1 * 60) {
                                                                                                                                                                                                                                                  // 1) Local backup
                                                                                                                                                                                                                                                          createBackup($bkDir);
                                                                                                                                                                                                                                                                  // 2) Find latest
                                                                                                                                                                                                                                                                          $files = glob("$bkDir/backup_*.zip");
                                                                                                                                                                                                                                                                                  usort($files, function($a, $b) {
                                                                                                                                                                                                                                                                                              return filemtime($b) - filemtime($a);
                                                                                                                                                                                                                                                                                                      });
                                                                                                                                                                                                                                                                                                              if (!empty($files)) {
                                                                                                                                                                                                                                                                                                                          $latest     = $files[0];
                                                                                                                                                                                                                                                                                                                                      $uploadPath = '/Backups/' . basename($latest);
                                                                                                                                                                                                                                                                                                                                                  $data       = file_get_contents($latest);
                                                                                                                                                                                                                                                                                                                                                              // 3) Upload
                                                                                                                                                                                                                                                                                                                                                                          $token = getDropboxAccessToken();
                                                                                                                                                                                                                                                                                                                                                                                      if ($token) {
                                                                                                                                                                                                                                                                                                                                                                                                      $ch = curl_init('https://content.dropboxapi.com/2/files/upload');
                                                                                                                                                                                                                                                                                                                                                                                                                      curl_setopt_array($ch, [
                                                                                                                                                                                                                                                                                                                                                                                                                                          CURLOPT_POST           => true,
                                                                                                                                                                                                                                                                                                                                                                                                                                                              CURLOPT_RETURNTRANSFER => true,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  CURLOPT_HTTPHEADER     => [
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          'Authorization: Bearer ' . $token,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  'Content-Type: application/octet-stream',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          'Dropbox-API-Arg: ' . json_encode([
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      'path'       => $uploadPath,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  'mode'       => 'add',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              'autorename' => false,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          'mute'       => true,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  ]),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      ],
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          CURLOPT_POSTFIELDS     => $data,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          ]);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          $resp = curl_exec($ch);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          $code = curl_getinfo($ch, CURLINFO_HTTP_CODE);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          curl_close($ch);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          if ($code === 200) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              // Cleanup remote older backups
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  $ch = curl_init('https://api.dropboxapi.com/2/files/list_folder');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      curl_setopt_array($ch, [
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              CURLOPT_POST           => true,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      CURLOPT_RETURNTRANSFER => true,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              CURLOPT_HTTPHEADER     => [
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          'Authorization: Bearer ' . $token,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      'Content-Type: application/json',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              ],
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      CURLOPT_POSTFIELDS     => json_encode(['path'=>'/Backups','limit'=>1000]),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          ]);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              $list = json_decode(curl_exec($ch), true)['entries'] ?? [];
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  curl_close($ch);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      usort($list, function($a, $b) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              return strtotime($a['server_modified']) - strtotime($b['server_modified']);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      $removeCount = count($list) - 32;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          for ($i=0; $i<$removeCount; $i++) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  $delCh = curl_init('https://api.dropboxapi.com/2/files/delete_v2');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          curl_setopt_array($delCh, [
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      CURLOPT_POST           => true,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  CURLOPT_RETURNTRANSFER => true,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              CURLOPT_HTTPHEADER     => [
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              'Authorization: Bearer ' . $token,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              'Content-Type: application/json',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          ],
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      CURLOPT_POSTFIELDS     => json_encode(['path'=>$list[$i]['path_lower']]),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              ]);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      curl_exec($delCh);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              curl_close($delCh);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      // Cleanup local older backups
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          $local = glob("$bkDir/backup_*.zip");
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              usort($local, function($a, $b) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      return filemtime($b) - filemtime($a);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              foreach (array_slice($local,2) as $old) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      @unlink($old);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          } else {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              error_log("Dropbox upload failed ($code): $resp");
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          // 4) Update timestamp
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  file_put_contents($timeFile, $now);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      // End of script